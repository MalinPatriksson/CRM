<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget och Statistik</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body class="bg-light">
<div class="app-container position-relative" style="width: 1300px; height: auto; justify-content: center">
    <a th:href="@{/.}" class="btn btn-primary position-absolute" style="top: 10px; right: 10px;">Startsida</a>

    <h1 class="text-center">Budget och Statistik</h1>

    <!-- Filtreringssektion -->
    <form id="budgetFilterForm" action="/budget" method="get">
        <div class="d-flex flex-wrap justify-content-center gap-3 mt-4">

            <!-- Filtrera p친 친r -->
            <div class="dropdown">
                <button class="btn btn-light dropdown-toggle" type="button" id="filterYearBtn" data-bs-toggle="dropdown" aria-expanded="false">
                    V칛lj 친r
                </button>
                <ul class="dropdown-menu" aria-labelledby="filterYearBtn">
                    <li>
                        <label class="dropdown-item">
                            <input type="checkbox" id="selectAllYears"> Alla
                        </label>
                    </li>
                    <li th:each="year : ${availableYears}">
                        <label class="dropdown-item">
                            <input type="checkbox" name="years" class="year-checkbox" th:value="${year}">
                            <span th:text="${year}"></span>
                        </label>
                    </li>
                </ul>
            </div>

            <!-- Filtrera p친 finansi칛r -->
            <div class="dropdown">
                <button class="btn btn-light dropdown-toggle" type="button" id="filterFundingBtn" data-bs-toggle="dropdown" aria-expanded="false">
                    V칛lj finansi칛r
                </button>
                <ul class="dropdown-menu" aria-labelledby="filterFundingBtn">
                    <li>
                        <label class="dropdown-item">
                            <input type="checkbox" id="selectAllFunders"> Alla
                        </label>
                    </li>
                    <li th:each="funding : ${fundingSources}">
                        <label class="dropdown-item">
                            <input type="checkbox" name="funders" class="funder-checkbox" th:value="${funding}">
                            <span th:text="${funding}"></span>
                        </label>
                    </li>
                </ul>
            </div>

            <!-- Filtrera p친 person -->
            <div class="dropdown">
                <button class="btn btn-light dropdown-toggle" type="button" id="filterPersonBtn" data-bs-toggle="dropdown" aria-expanded="false">
                    V칛lj person
                </button>
                <ul class="dropdown-menu" aria-labelledby="filterPersonBtn">
                    <li>
                        <label class="dropdown-item">
                            <input type="checkbox" id="selectAllPersons"> Alla
                        </label>
                    </li>
                    <li th:each="person : ${projectManagers}">
                        <label class="dropdown-item">
                            <input type="checkbox" name="persons" class="person-checkbox" th:value="${person}">
                            <span th:text="${person}"></span>
                        </label>
                    </li>
                </ul>
            </div>
        </div>

        <div class="d-flex mt-3 justify-content-center">
            <button type="button" id="applyFilters" class="btn btn-primary">Visa statistik</button>
            <button type="button" id="resetFilters" class="btn btn-secondary ms-3">칀terst칛ll</button>
        </div>
    </form>

    <!-- Visar summan av s칬kta pengar -->
    <div class="mt-5 text-center">
        <h3>Total budget: <span id="totalBudgetValue">0 SEK</span></h3>
    </div>

    <!-- Stapeldiagram -->
    <div class="mt-4">
        <canvas id="budgetChart"></canvas>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {

        /** 游댳 Funktion f칬r att h칛mta valda filtreringsparametrar **/
        function getFilterParams() {
            let params = new URLSearchParams();

            // H칛mta valda 친r
            document.querySelectorAll("input[name='years']:checked").forEach(cb => {
                params.append("years", cb.value);
            });

            // H칛mta valda finansi칛rer
            document.querySelectorAll("input[name='funders']:checked").forEach(cb => {
                params.append("funders", cb.value);
            });

            // H칛mta valda personer
            document.querySelectorAll("input[name='persons']:checked").forEach(cb => {
                params.append("persons", cb.value);
            });

            return params.toString();
        }

        /** 游댳 Uppdatera total budget **/
        function updateTotalBudget() {
            fetch('/budget/total?' + getFilterParams())
                .then(response => response.json())
                .then(data => {
                    document.querySelector("#totalBudgetValue").textContent = data.totalBudget;
                })
                .catch(error => console.error("Error fetching budget:", error));
        }


        /** 游댳 Uppdatera stapeldiagram **/
        function updateChart() {
            fetch('/budget/chart?' + getFilterParams())
                .then(response => response.json())
                .then(data => {
                    let ctx = document.getElementById('budgetChart').getContext('2d');

                    // Om diagrammet redan existerar, f칬rst칬r det innan vi skapar ett nytt
                    if (window.budgetChart && typeof window.budgetChart.destroy === "function") {
                        window.budgetChart.destroy();
                    }

                    // Skapa nytt diagram
                    window.budgetChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: data.labels,
                            datasets: [{
                                label: 'S칬kta medel',
                                data: data.values,
                                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: { beginAtZero: true }
                            }
                        }
                    });
                })
                .catch(error => console.error("Error fetching chart data:", error));
        }

        /** 游댳 Hantera "Alla" checkboxar **/
        function handleSelectAll(selectAllCheckbox, checkboxes) {
            selectAllCheckbox.addEventListener("change", function () {
                checkboxes.forEach(checkbox => checkbox.checked = this.checked);
                triggerFilters();
            });

            checkboxes.forEach(checkbox => {
                checkbox.addEventListener("change", function () {
                    if (!this.checked) {
                        selectAllCheckbox.checked = false;
                    } else if (Array.from(checkboxes).every(cb => cb.checked)) {
                        selectAllCheckbox.checked = true;
                    }
                    triggerFilters();
                });
            });
        }

        /** 游댳 K칬r filtreringen n칛r en checkbox 칛ndras **/
        function addCheckboxListeners() {
            document.querySelectorAll("input[type='checkbox']").forEach(cb => {
                cb.addEventListener("change", triggerFilters);
            });
        }

        /** 游댳 K칬r filtreringen **/
        function triggerFilters() {
            updateTotalBudget();
            updateChart();
        }

        /** 游댳 Hantera 친terst칛llningsknappen **/
        document.getElementById("resetFilters").addEventListener("click", function (event) {
            event.preventDefault();

            // Avmarkera alla checkboxar
            document.querySelectorAll("input[type='checkbox']").forEach(cb => cb.checked = false);

            // Uppdatera filtrering
            triggerFilters();
        });

        /** 游댳 Koppla checkboxarna f칬r "Alla" till deras listor **/
        handleSelectAll(document.getElementById("selectAllYears"), document.querySelectorAll(".year-checkbox"));
        handleSelectAll(document.getElementById("selectAllFunders"), document.querySelectorAll(".funder-checkbox"));
        handleSelectAll(document.getElementById("selectAllPersons"), document.querySelectorAll(".person-checkbox"));

        /** 游댳 L칛gg till event listeners f칬r alla checkboxar **/
        addCheckboxListeners();

        /** 游댳 Koppla filtreringsknappen **/
        document.getElementById("applyFilters").addEventListener("click", triggerFilters);

        /** 游댳 Initiera datan n칛r sidan laddas **/
        updateTotalBudget();
        updateChart();
    });

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
