<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L√§gg till Projekt</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body class="bg-light">
<div class="app-container position-relative" style="width: 1600px; height: auto; justify-content: center">

    <h2 class="text-center mb-3">L√§gg till Projekt</h2>

    <div th:if="${errorMessage}" class="alert alert-danger text-center">
        <strong th:text="${errorMessage}"></strong>
    </div>



    <!-- Fil-uppladdning f√∂r b√•de PDF & Excel -->
    <form th:action="@{/upload-excel}" method="post" enctype="multipart/form-data" class="mb-3">
        <div class="card">
            <div class="card-body">
                <h6 class="card-title">Ladda upp Excel-fil f√∂r att fylla i projektuppgifter</h6>

                <!-- Drag & Drop Area -->
                <div id="drop-area" class="border rounded p-4 text-center bg-light mb-3">
                    <p>Dra in en Excel-fil eller klicka f√∂r att v√§lja</p>
                    <input type="file" id="file" name="file" class="form-control" accept=".xlsx,.xlsm" hidden>
                    <button type="button" class="btn btn-primary btn-sm" onclick="document.getElementById('file').click()">V√§lj fil</button>
                    <p id="fileName" class="mt-2 text-muted"></p>
                </div>

                <!-- Original submit button -->
                <div class="input-group">
                    <button type="submit" class="btn btn-primary btn-sm">Bearbeta Fil</button>
                </div>
            </div>
        </div>
    </form>


    <!-- Formul√§r f√∂r att l√§gga till projekt -->
    <form id="projectForm" method="post" action="/add" enctype="multipart/form-data" novalidate>
        <div class="card">
            <div class="card-body">
                <h6 class="card-title">Projektinformation</h6>
                <div class="row g-2">
                    <div class="col-md-6">
                        <label for="name" class="form-label">Projektnamn</label>
                        <input type="text" id="name" name="name" class="form-control required-field"
                               th:value="${extractedData['Projektnamn']} ?: ''">
                    </div>
                    <div class="col-md-6">
                        <label for="diaryNumber" class="form-label">Diarienummer</label>
                        <input type="text" id="diaryNumber" name="diaryNumber" class="form-control required-field"
                               th:value="${#strings.replace(extractedData['Diarienummer'], ':', '')} ?: ''">
                    </div>
                </div>
                <div class="row g-2 mt-2">
                    <div class="col-md-6">
                        <label for="manager" class="form-label">Projektledare</label>
                        <input type="text" id="manager" name="manager" class="form-control required-field"
                               th:value="${extractedData['Projektledares f√∂r- och efternamn']} ?: ''">
                    </div>
                    <div class="col-md-6">
                        <label for="fundingSource" class="form-label">Finansi√§r</label>
                        <input type="text" id="fundingSource" name="fundingSource" class="form-control required-field"
                               th:value="${#strings.replace(extractedData['Finansi√§r'], 'Motpart:', '')} ?: ''">
                    </div>
                </div>
                <div class="row g-2 mt-2">
                    <div class="col-md-6">
                        <label for="startDate" class="form-label">Startdatum</label>
                        <input type="date" id="startDate" name="startDate" class="form-control required-field"
                               th:value="${extractedData['Startdatum']} ?: ''">
                    </div>
                    <div class="col-md-6">
                        <label for="deadline" class="form-label">Slutdatum</label>
                        <input type="date" id="deadline" name="deadline" class="form-control required-field"
                               th:value="${extractedData['Deadline']} ?: ''">
                    </div>
                </div>
                <div class="row g-2 mt-2">
                    <!-- Forskningsprogram -->
                    <div class="col-md-6">
                        <label for="researchProgram" class="form-label">Forskningsprogram</label>
                        <input type="text" id="researchProgram" name="researchProgram" class="form-control required-field"
                               th:value="${#strings.replace(extractedData['Forskningsprogram'], ':', '')} ?: ''">
                    </div>

                    <!-- Akademi -->
                    <div class="col-md-6 d-flex align-items-end">
                        <div>
                            <label class="form-label d-block">Akademi</label>
                            <div id="academyCheckboxes" class="d-flex flex-wrap gap-3" data-required-academy="true">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" name="academies" value="ITE" id="academy-ite"
                                           th:checked="${project?.academies != null and project.academies.contains('ITE')}">
                                    <label class="form-check-label" for="academy-ite">ITE</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" name="academies" value="FIH" id="academy-fih"
                                           th:checked="${project?.academies != null and project.academies.contains('FIH')}">
                                    <label class="form-check-label" for="academy-fih">FIH</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" name="academies" value="LHS" id="academy-lhs"
                                           th:checked="${project?.academies != null and project.academies.contains('LHS')}">
                                    <label class="form-check-label" for="academy-lhs">LHS</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" name="academies" value="HOV" id="academy-hov"
                                           th:checked="${project?.academies != null and project.academies.contains('HOV')}">
                                    <label class="form-check-label" for="academy-hov">HOV</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- üîπ STATUS & DATUM -->
                <div class="row g-2 mt-2">
                    <div class="col-md-4">
                        <label for="status" class="form-label">Projektstatus</label>
                        <select id="status" name="status" class="form-select required-field" th:value="${project?.currentStatus ?: 'Id√©'}">
                            <option value="Id√©" th:selected="${project?.currentStatus == 'Id√©'}">Id√©</option>
                            <option value="Ans√∂kan" th:selected="${project?.currentStatus == 'Ans√∂kan'}">P√•b√∂rjad ans√∂kan</option>
                            <option value="S√∂kt" th:selected="${project?.currentStatus == 'S√∂kt'}">S√∂kt</option>
                            <option value="Beviljat" th:selected="${project?.currentStatus == 'Beviljat'}">Beviljat</option>
                            <option value="Avslag" th:selected="${project?.currentStatus == 'Avslag'}">Avslag</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="statusDate" class="form-label">Datum f√∂r status√§ndring</label>
                        <input type="date" id="statusDate" name="statusDate" class="form-control"
                               th:value="${project?.statusDate ?: #dates.format(#dates.createNow(), 'yyyy-MM-dd')}">
                    </div>
                    <div class="col-md-4">
                        <label for="expectedResponseDate" class="form-label">F√∂rv√§ntat svar</label>
                        <input type="date" id="expectedResponseDate" name="expectedResponseDate" class="form-control required-field"
                               th:value="${project?.expectedResponseDate ?: ''}">
                    </div>
                </div>


                <!-- üîπ Viktning - Sannolikhet f√∂r godk√§nnande -->
                <div class="row justify-content-center align-items-center mt-4">
                    <div class="col-md-2 text-end">
                        <label for="weighting" class="form-label mb-0">Viktning (%)</label>
                    </div>
                    <div class="col-md-1">
                        <input type="number" id="weighting" name="weighting" class="form-control text-center required-field"
                               min="0" max="100" th:value="${currentStatusWeighting}" oninput="updateWeightingBar(this.value)" />
                    </div>
                    <div class="col-md-6">
                        <div class="progress" style="height: 36px;">
                            <div id="weightingBar" class="progress-bar bg-success d-flex align-items-center justify-content-center"
                                 role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                <span id="weightingText">0%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Budget Information -->
        <div class="card mt-4">
            <div class="card-body">
                <h5 class="card-title">Budget√∂versikt</h5>

                <div class="table-responsive" style="max-height: 400px;">
                    <table class="table table-bordered">
                        <thead>
                        <tr>
                            <th>Int√§kter</th>
                            <th th:each="year : ${extractedData['Years']}" th:text="${year}"></th>
                            <th>Total</th>
                        </tr>
                        </thead>
                        <tbody id="budgetTableBody">
                        <tr th:each="row, rowStat : ${extractedData['BudgetRows']}">
                            <td>
                                <input type="text" th:name="'budgetRows[' + ${rowStat.index} + '][Rubrik]'" class="form-control"
                                       th:value="${row['Rubrik']} ?: ''"/>
                            </td>
                            <td th:each="year : ${extractedData['Years']}">
                                <input type="text"
                                       th:name="'budgetRows[' + ${rowStat.index} + '][' + ${year} + ']'"
                                       class="form-control"
                                       th:value="${row[year + '']} ?: '0.0'"/>
                            </td>
                            <td>
                                <input type="text" th:name="'budgetRows[' + ${rowStat.index} + '][Total]'" class="form-control"
                                       th:value="${row['Total']} ?: ''"/>
                            </td>
                        </tr>
                        </tbody>

                    </table>
                </div>
            </div>
        </div>

        <!-- Knapp f√∂r att l√§gga till projekt -->
        <div class="mt-3 text-center">
            <button type="submit" class="btn btn-success">L√§gg till projekt</button>
            <a th:href="@{/projects}" class="btn btn-secondary">Tillbaka</a>
        </div>
            </div>
        </div>
    </form>
</div>

<!-- Modal f√∂r att visa saknade f√§lt -->
<div class="modal fade" id="missingFieldsModal" tabindex="-1" aria-labelledby="missingFieldsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="missingFieldsModalLabel">‚ö†Ô∏è Saknade f√§lt</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="St√§ng"></button>
            </div>
            <div class="modal-body">
                <p>F√∂ljande f√§lt √§r inte ifyllda:</p>
                <ul id="missingFieldsList" class="text-danger"></ul>
                <p>Vill du spara √§nd√•?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Avbryt</button>
                <button type="button" id="confirmSaveButton" class="btn btn-danger">Spara √§nd√•</button>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const statusSelect = document.getElementById("status");
        const weightingInput = document.getElementById("weighting");
        const weightingBar = document.getElementById("weightingBar");
        const weightingText = document.getElementById("weightingText");
        const projectForm = document.getElementById("projectForm");
        const requiredFields = document.querySelectorAll(".required-field");
        const missingFieldsList = document.getElementById("missingFieldsList");
        const confirmSaveButton = document.getElementById("confirmSaveButton");

        const dropArea = document.getElementById("drop-area");
        const fileInput = document.getElementById("file");
        const fileNameDisplay = document.getElementById("fileName");

        // üü¢ Uppdatera weighting-baren visuellt
        function updateWeightingBar(value) {
            const safeValue = Math.max(0, Math.min(100, parseInt(value) || 0));
            weightingBar.style.width = safeValue + "%";
            weightingBar.setAttribute("aria-valuenow", safeValue);
            weightingText.innerText = safeValue + "%";
        }

        // üü¢ S√§tt viktning baserat p√• status
        function updateWeighting() {
            let percentage = parseInt(weightingInput.value);

            if (statusSelect.value === "Beviljat") {
                percentage = 100;
            } else if (statusSelect.value === "Avslag") {
                percentage = 0;
            }

            weightingInput.value = percentage;
            updateWeightingBar(percentage);
        }

        // üõ°Ô∏è Formul√§rvalidering + modalf√∂nster
        function validateForm(event) {
            event.preventDefault();
            let missingFields = [];
            let isValid = true;

            // üîπ Validera vanliga required-fields (inputs/selects)
            requiredFields.forEach(field => {
                let value = field.value;

                if (field.tagName === "SELECT") {
                    value = field.options[field.selectedIndex]?.value || "";
                } else if (["date", "number", "text"].includes(field.type)) {
                    value = value?.toString().trim();
                }

                if (!value) {
                    field.classList.add("is-invalid");
                    let label = document.querySelector(`label[for="${field.id}"]`) ||
                        field.closest(".col, .col-md-1, .col-md-2, .col-md-4, .col-md-6")?.querySelector("label");
                    const labelText = label?.innerText?.trim() || "Ok√§nt f√§lt";
                    missingFields.push(labelText);
                    isValid = false;
                } else {
                    field.classList.remove("is-invalid");
                }
            });

            // üîπ Kontrollera att minst en akademi √§r vald
            const academyContainer = document.querySelector('[data-required-academy]');
            const checkboxes = academyContainer.querySelectorAll('input[type="checkbox"]');
            const oneChecked = Array.from(checkboxes).some(cb => cb.checked);
            if (!oneChecked) {
                academyContainer.classList.add("border", "border-danger", "rounded");
                missingFields.push("Akademi (minst en m√•ste v√§ljas)");
                isValid = false;
            } else {
                academyContainer.classList.remove("border", "border-danger", "rounded");
            }

            // üîπ Visa modal eller skicka formul√§ret
            if (!isValid) {
                missingFieldsList.innerHTML = missingFields.map(f => `<li>${f}</li>`).join("");
                new bootstrap.Modal(document.getElementById("missingFieldsModal")).show();
            } else {
                projectForm.submit();
            }
        }


        // üîÑ Init vid sidladdning
        updateWeighting();
        updateWeightingBar(weightingInput.value);

        // üéØ Event Listeners
        statusSelect.addEventListener("change", updateWeighting);
        weightingInput.addEventListener("input", () => updateWeightingBar(weightingInput.value));
        projectForm.addEventListener("submit", validateForm);
        confirmSaveButton.addEventListener("click", () => projectForm.submit());

        // üì• Drag & Drop Excel (.xlsx)
        dropArea.addEventListener("dragover", (e) => {
            e.preventDefault();
            dropArea.classList.add("border-primary");
        });

        dropArea.addEventListener("dragleave", () => {
            dropArea.classList.remove("border-primary");
        });

        dropArea.addEventListener("drop", (e) => {
            e.preventDefault();
            dropArea.classList.remove("border-primary");
            const droppedFile = e.dataTransfer.files[0];
            if (
                droppedFile &&
                (droppedFile.name.endsWith(".xlsx") || droppedFile.name.endsWith(".xlsm"))
            ) {
                fileInput.files = e.dataTransfer.files;
                fileNameDisplay.textContent = "Vald fil: " + droppedFile.name;
            } else {
                alert("Endast .xlsx eller .xlsm-filer st√∂ds.");
            }

        });

        fileInput.addEventListener("change", () => {
            if (fileInput.files.length > 0) {
                fileNameDisplay.textContent = "Vald fil: " + fileInput.files[0].name;
            }
        });
    });
</script>

</body>
</html>
