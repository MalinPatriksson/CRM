<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alla Projekt</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/style.css}"></head>

<body class="bg-light">
<div class="app-container" style="width: 1400px; height: 800px; justify-content: center">
    <div th:if="${message}" class="alert alert-success alert-dismissible fade show" role="alert">
        <p th:text="${message}"></p>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <h1 class="mb-4 text-center">Alla Projekt</h1>

    <!-- Sökrutan: Separat rad -->
    <div class="mb-4">
        <form action="/projects" method="get" class="d-flex justify-content-center align-items-center">
            <label>
                <input type="text" name="keyword" class=" me-2 search" placeholder=" Sök efter projekt eller ansvarig" style="text-align: left;">
            </label>
            <button type="submit" class="btn btn-primary px-4">Sök</button>
        </form>
    </div>


    <!-- Scrollbar för tabellen -->
    <div class="table-responsive fixed-table-container project-table">
        <table class="table">
            <thead>
            <tr>
                <th style="min-width: 50px;">#</th>
                <th style="min-width: 200px;">
                    <a th:href="@{/projects(page=1, sortBy='name', order=${sortBy == 'name' and order == 'asc' ? 'desc' : 'asc'})}">
                        Projektets namn
                        <span th:if="${sortBy == 'name'}" th:text="${order == 'asc' ? '↑' : '↓'}"></span>
                    </a>
                </th>
                <th style="min-width: 150px;">
                    <a th:href="@{/projects(page=1, sortBy='manager', order=${sortBy == 'manager' and order == 'asc' ? 'desc' : 'asc'})}">
                        Ansvarig
                        <span th:if="${sortBy == 'manager'}" th:text="${order == 'asc' ? '↑' : '↓'}"></span>
                    </a>
                </th>
                <th style="min-width: 150px;">
                    <a th:href="@{/projects(page=1, sortBy='deadline', order=${sortBy == 'deadline' and order == 'asc' ? 'desc' : 'asc'})}">
                        Deadline
                        <span th:if="${sortBy == 'deadline'}" th:text="${order == 'asc' ? '↑' : '↓'}"></span>
                    </a>
                </th>
                <th>Åtgärder</th>

            </tr>
            </thead>
            <tbody>
            <tr th:each="project, iterStat : ${projects}">
                <td th:text="${iterStat.index + 1}"></td>
                <td>
                    <a href="#" class="text-primary" data-bs-toggle="modal" th:attr="data-bs-target='#projectModal'" th:attrappend="data-project-id=${project.id}">
                        <span th:text="${project.name}"></span>
                    </a>
                </td>
                <td th:text="${project.manager}"></td>
                <td th:text="${project.deadline}"></td>
                <!-- Ändra-knapp i varje rad -->
                <td>
                    <a th:href="@{/edit-project/{id}(id=${project.id})}" class="btn btn-warning btn-sm d-flex mb-2">Ändra</a>
                    <a th:href="@{/projects/{id}/budget(id=${project.id})}" class="btn btn-info btn-sm d-flex">Visa Budget</a>

                </td>
            </tr>
            </tbody>

        </table>
    </div>

    <!-- Paginering -->
    <div class="d-flex mt-4">
        <nav>
            <ul class="pagination">
                <li class="page-item">
                    <a class="page-link" th:href="@{/projects?page=${currentPage - 1}}" th:if="${currentPage > 1}">Föregående</a>
                </li>
                <li class="page-item" th:each="page : ${pages}">
                    <a class="page-link" th:href="@{/projects?page=${page}}" th:text="${page}" th:classappend="${page == currentPage} ? 'active'"></a>
                </li>
                <li class="page-item">
                    <a class="page-link" th:href="@{/projects?page=${currentPage + 1}}" th:if="${currentPage < totalPages}">Nästa</a>
                </li>
            </ul>
        </nav>
    </div>

    <div class="d-flex mb-3">
        <a th:href="@{/}" class="btn btn-secondary">Tillbaka</a>
        <a th:href="@{/add-project}" class="btn btn-success">Lägg till projekt</a>
    </div>
</div>

<!-- Modal för projektinfo -->
<div class="modal fade" id="projectModal" tabindex="-1" aria-labelledby="projectModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg"> <!-- Större modal -->
        <div class="modal-content">
            <div class="modal-header bg-secondary text-white">
                <h5 class="modal-title" id="projectModalLabel">Projektinformation</h5>
                <button type="button" class="btn-close text-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Projektinformation -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <p><strong>Projektets namn:</strong> <span id="modal-project-name"></span></p>
                        <p><strong>Ansvarig:</strong> <span id="modal-project-manager"></span></p>
                        <p><strong>Startdatum:</strong> <span id="modal-project-start"></span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Deadline:</strong> <span id="modal-project-deadline"></span></p>
                        <p><strong>Totalt spenderat:</strong> <span id="modal-spent"></span></p>
                    </div>
                </div>
                <!-- Budget-information -->
                <h6 class="mb-3 text-muted">Budgetöversikt</h6>
                <div class="row">
                    <div class="col-md-4">
                        <div class="card border-secondary mb-3">
                            <div class="card-header bg-secondary text-white">Budget År 1</div>
                            <div class="card-body">
                                <p class="card-text"><span id="modal-budget1"></span></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-secondary mb-3">
                            <div class="card-header bg-secondary text-white">Budget År 2</div>
                            <div class="card-body">
                                <p class="card-text"><span id="modal-budget2"></span></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-secondary mb-3">
                            <div class="card-header bg-secondary text-white">Budget År 3</div>
                            <div class="card-body">
                                <p class="card-text"><span id="modal-budget3"></span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Diagram -->
                <div class="mt-4">
                    <h6 class="mb-3 text-muted">Spendering vs Budget</h6>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <button id="toggleChartType" class="btn btn-outline-primary">Växla till stapeldiagram</button>
                    </div>
                    <canvas id="budgetChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    projectModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget; // Hämta knappen som triggar modalen
        const projectId = button.getAttribute('data-project-id');

        fetch(`/project/${projectId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error("Kunde inte hämta projekt.");
                }
                return response.json();
            })
            .then(project => {
                // Uppdatera modalens innehåll
                document.getElementById('modal-project-start').textContent = project.startDate || "Okänt startdatum";
                document.getElementById('modal-project-name').textContent = project.name || "Okänt projekt";
                document.getElementById('modal-project-manager').textContent = project.manager || "Okänd ansvarig";
                document.getElementById('modal-project-deadline').textContent = project.deadline || "Ingen deadline";
                document.getElementById('modal-budget1').textContent = project.budgetYear1 + " SEK";
                document.getElementById('modal-budget2').textContent = project.budgetYear2 + " SEK";
                document.getElementById('modal-budget3').textContent = project.budgetYear3 + " SEK";
                document.getElementById('modal-spent').textContent = project.spent + " SEK";

                const startDate = new Date(project.startDate);
                const currentYear = new Date().getFullYear();
                const projectYear = Math.min(currentYear - startDate.getFullYear() + 1, 3); // Max 3 år
                const totalYears = 4; // År 0 till År 3

                // Förväntad spendering (grön linje)
                const expectedSpending = [0, project.budgetYear1, project.budgetYear1 + project.budgetYear2, project.budgetYear1 + project.budgetYear2 + project.budgetYear3];

                // Faktisk spendering (röd linje)
                const actualSpending = [0];
                let accumulatedSpent = 0;

                for (let i = 1; i <= totalYears; i++) {
                    if (i <= projectYear) {
                        accumulatedSpent += project.spent / projectYear; // Dela upp spenderingen jämt över aktuella år
                        actualSpending.push(accumulatedSpent);
                    } else {
                        actualSpending.push(null); // Ingen spendering för framtida år
                    }
                }

                // Prognos (streckad linje)
                const trendSpending = [...actualSpending];
                const lastYearSpent = actualSpending[projectYear];
                const trendPerYear = actualSpending[projectYear] - actualSpending[projectYear - 1];

                for (let i = projectYear + 1; i <= totalYears; i++) {
                    trendSpending[i] = lastYearSpent + trendPerYear * (i - projectYear);
                }

                // Ta bort tidigare graf om den finns
                if (window.budgetChart && typeof window.budgetChart.destroy === 'function') {
                    window.budgetChart.destroy();
                }

                let chartType = 'line'; // Standarddiagramtyp

                document.getElementById('toggleChartType').addEventListener('click', () => {
                    chartType = chartType === 'line' ? 'bar' : 'line'; // Växla typ
                    const toggleButton = document.getElementById('toggleChartType');
                    toggleButton.textContent = chartType === 'line' ? 'Växla till stapeldiagram' : 'Växla till linjediagram';

                    // Återskapa diagrammet med ny typ
                    if (window.budgetChart && typeof window.budgetChart.destroy === 'function') {
                        window.budgetChart.destroy();
                    }
                    renderChart(); // Funktion för att rendera diagrammet
                });

                function renderChart() {
                    const ctx = document.getElementById('budgetChart').getContext('2d');
                    const labels = chartType === 'line' ? ['År 0', 'År 1', 'År 2', 'År 3'] : ['År 1', 'År 2', 'År 3'];
                    const adjustedTrendSpending =
                        chartType === 'bar'
                            ? trendSpending.map((value, index) => (index <= projectYear ? null : value)).slice(1) // Visa trend endast för framtida år
                            : trendSpending;

                    const adjustedActualSpending =
                        chartType === 'bar' ? actualSpending.slice(1) : actualSpending; // Ta bort år 0 för stapeldiagram

                    window.budgetChart = new Chart(ctx, {
                        type: chartType, // Använd den aktuella diagramtypen
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: 'Förväntad spendering',
                                    data: chartType === 'bar' ? expectedSpending.slice(1) : expectedSpending, // Ta bort år 0 för stapeldiagram
                                    borderColor: chartType === 'line' ? '#4caf50' : undefined,
                                    backgroundColor: chartType === 'bar' ? '#4caf50' : 'rgba(76, 175, 80, 0.2)',
                                    tension: 0.4,
                                },
                                {
                                    label: 'Faktisk spendering',
                                    data: adjustedActualSpending,
                                    borderColor: chartType === 'line' ? '#f44336' : undefined,
                                    backgroundColor: chartType === 'bar' ? '#f44336' : 'rgba(244, 67, 54, 0.2)',
                                    tension: 0.4,
                                },
                                ...(chartType === 'line'
                                    ? [
                                        {
                                            label: 'Prognos (trend)',
                                            data: adjustedTrendSpending,
                                            borderColor: '#2196f3',
                                            borderDash: [5, 5],
                                            fill: false,
                                            tension: 0.4,
                                        },
                                    ]
                                    : [
                                        {
                                            label: 'Prognos (trend)',
                                            data: adjustedTrendSpending,
                                            backgroundColor: 'rgba(33, 150, 243, 0.4)', // Blå staplar för framtida trend
                                            borderColor: '#2196f3',
                                            borderWidth: 1,
                                        },
                                    ]), // Lägg endast till trend om det är relevant
                            ],
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { position: 'top' },
                                tooltip: { enabled: true },
                            },
                            scales: {
                                x: {
                                    title: { display: true, text: 'År' },
                                },
                                y: {
                                    title: { display: true, text: 'Spendering (SEK)' },
                                    beginAtZero: true,
                                    suggestedMax: Math.max(...expectedSpending) * 1.5, // Tillåt skalan att gå högre än budget
                                },
                            },
                        },
                    });
                }

                renderChart();

            });
    });

</script>
</body>
</html>
